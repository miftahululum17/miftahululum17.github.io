// Configuration
const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', // Ganti dengan URL Web App Anda
    LOCAL_STORAGE_KEY: 'quizAppData',
    SYNC_INTERVAL: 30000 // Sync every 30 seconds
};

// Database Functions
async function callAPI(action, params = {}) {
    try {
        const url = new URL(CONFIG.API_URL);
        url.searchParams.append('action', action);
        
        // Add all parameters
        Object.keys(params).forEach(key => {
            if (params[key] !== undefined && params[key] !== null) {
                url.searchParams.append(key, params[key]);
            }
        });
        
        // Add timestamp to prevent caching
        url.searchParams.append('_t', Date.now());
        
        console.log(`Calling API: ${action}`, params);
        
        const response = await fetch(url.toString());
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Unknown error');
        }
        
        return data;
        
    } catch (error) {
        console.error(`API Error (${action}):`, error);
        
        // Fallback to local storage
        return await handleOfflineAction(action, params);
    }
}

// Handle offline actions
async function handleOfflineAction(action, params) {
    loadFromLocalStorage();
    
    switch(action) {
        case 'getUsers':
            return { success: true, users: state.users };
        case 'getWithdrawals':
            const withdrawals = params.userId ? 
                state.withdrawals.filter(w => w.userId == params.userId) : 
                state.withdrawals;
            return { success: true, withdrawals: withdrawals };
        case 'getSettings':
            return { success: true, settings: state.settings };
        case 'login':
            return handleOfflineLogin(params);
        case 'register':
            return handleOfflineRegister(params);
        case 'updateUser':
            return handleOfflineUpdateUser(params);
        case 'createWithdrawal':
            return handleOfflineCreateWithdrawal(params);
        default:
            return { 
                success: false, 
                error: 'Action not supported offline' 
            };
    }
}

// Offline handlers
function handleOfflineLogin(params) {
    const user = state.users.find(u => 
        u.username === params.username && 
        u.password === params.password && 
        u.isBlocked !== 'true'
    );
    
    if (user) {
        user.lastLogin = new Date().toISOString();
        saveToLocalStorage();
        return { 
            success: true, 
            message: 'Login berhasil (offline mode)', 
            user: user 
        };
    }
    
    return { 
        success: false, 
        error: 'Username atau password salah' 
    };
}

function handleOfflineRegister(params) {
    if (state.users.some(u => u.username === params.username)) {
        return { 
            success: false, 
            error: 'Username sudah digunakan' 
        };
    }
    
    const role = state.users.length === 0 ? 'admin' : 'user';
    const id = state.users.length + 1;
    
    const newUser = {
        id: id,
        username: params.username,
        password: params.password,
        role: role,
        points: 0,
        joinDate: new Date().toISOString(),
        deviceId: state.deviceId,
        isBlocked: 'false',
        lastLogin: ''
    };
    
    state.users.push(newUser);
    saveToLocalStorage();
    
    return { 
        success: true, 
        message: 'Pendaftaran berhasil (offline mode)', 
        user: newUser 
    };
}

// Local storage functions
function saveToLocalStorage() {
    const data = {
        users: state.users,
        withdrawals: state.withdrawals,
        settings: state.settings,
        lastSync: Date.now()
    };
    
    localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(data));
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
    if (saved) {
        const data = JSON.parse(saved);
        state.users = data.users || [];
        state.withdrawals = data.withdrawals || [];
        state.settings = data.settings || {};
        
        // Update settings
        state.maintenance = state.settings.maintenance === 'true';
        state.rewardPoints = parseInt(state.settings.rewardPoints) || 50;
    }
}

// Sync function
async function syncWithServer() {
    try {
        // Get all data from server
        const [usersData, withdrawalsData, settingsData] = await Promise.all([
            callAPI('getUsers'),
            callAPI('getWithdrawals'),
            callAPI('getSettings')
        ]);
        
        if (usersData.success) state.users = usersData.users;
        if (withdrawalsData.success) state.withdrawals = withdrawalsData.withdrawals;
        if (settingsData.success) {
            state.settings = settingsData.settings;
            state.maintenance = state.settings.maintenance === 'true';
            state.rewardPoints = parseInt(state.settings.rewardPoints) || 50;
        }
        
        // Save to local storage
        saveToLocalStorage();
        
        console.log('Data synced with server');
        return true;
        
    } catch (error) {
        console.error('Sync failed:', error);
        return false;
    }
}

// Initialize with server sync
async function initializeApp() {
    showLoading('Memuat aplikasi...');
    
    // First try to sync with server
    const synced = await syncWithServer();
    
    if (!synced) {
        // If sync fails, load from local storage
        loadFromLocalStorage();
        showToast('Mode offline aktif', 'info');
    }
    
    // Check auto-logout
    setInterval(checkAutoLogout, 60 * 60 * 1000);
    
    // Auto-sync every 30 seconds
    setInterval(syncWithServer, CONFIG.SYNC_INTERVAL);
    
    // Check if user is logged in
    const savedUserId = localStorage.getItem('currentUserId');
    if (savedUserId) {
        const user = state.users.find(u => u.id == savedUserId);
        if (user) {
            if (await login(user.username, user.password)) {
                hideLoading();
                return;
            }
        }
    }
