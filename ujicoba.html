// --- FUNGSI LOGOUT YANG DIPERBAIKI ---
function handleLogout() {
    // Menggunakan konfirmasi bawaan browser yang lebih stabil untuk Mini App
    const yakin = confirm("Apakah Anda yakin ingin keluar?");
    
    if (yakin) {
        // 1. Simpan poin terakhir ke database sebelum hapus sesi
        if (currentUser) {
            let users = JSON.parse(localStorage.getItem('users_db')) || {};
            if (users[currentUser]) {
                users[currentUser].points = p;
                localStorage.setItem('users_db', JSON.stringify(users));
            }
        }

        // 2. Hapus data sesi login
        localStorage.removeItem('session');
        
        // 3. Reset variabel global
        currentUser = null;
        p = 0;

        // 4. Paksa refresh halaman untuk kembali ke tampilan Auth (Login)
        window.location.reload();
    }
}

// --- PERBAIKAN INISIALISASI SESI (DI BAGIAN PALING BAWAH SCRIPT) ---
window.onload = function() {
    const sessionData = localStorage.getItem('session');
    if (sessionData) {
        const session = JSON.parse(sessionData);
        // Pastikan memanggil fungsi loginSuccess dengan data yang benar
        loginSuccess(session.username, session.points);
    } else {
        // Jika tidak ada sesi, pastikan halaman auth tampil
        document.getElementById('auth-page').style.display = 'flex';
    }
};
