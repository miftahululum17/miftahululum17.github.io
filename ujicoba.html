<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Matematika - Telegram Mini App</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Monetag Ads SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9865183' data-sdk='show_9865183'></script>
    <style>
        /* Semua CSS dari sebelumnya tetap sama */
        /* ... (paste semua CSS dari kode sebelumnya) ... */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div id="loadingText">Memuat data...</div>
    </div>

    <div class="container">
        <!-- Toast Notification -->
        <div id="toast" class="toast" style="display: none;"></div>

        <!-- Database Status -->
        <div id="dbStatus" class="db-status" style="display: none;">
            <i class="fas fa-database"></i> <span id="dbStatusText">Database: Offline</span>
        </div>

        <!-- Semua HTML dari sebelumnya tetap sama -->
        <!-- ... (paste semua HTML dari kode sebelumnya) ... -->
        
    </div>

    <script>
        // Telegram Web App Initialization
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        // Configuration
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', // Ganti dengan URL Web App Anda
            CACHE_DURATION: 30000,
            OFFLINE_MODE: true // Enable offline mode
        };

        // Application State
        const state = {
            currentUser: null,
            users: [],
            withdrawals: [],
            settings: {},
            maintenance: false,
            rewardPoints: 50,
            currentQuestion: null,
            correctAnswer: null,
            deviceId: generateDeviceId(),
            lastAutoLogout: null,
            lastFetchTime: {},
            cache: {},
            offlineMode: false,
            pendingSync: {
                users: [],
                withdrawals: [],
                settings: []
            }
        };

        // Generate unique device ID
        function generateDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // Database Functions
        async function callAPI(action, params = {}) {
            try {
                const url = new URL(CONFIG.API_URL);
                url.searchParams.append('action', action);
                
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, params[key]);
                });
                
                // Add timestamp to prevent caching
                url.searchParams.append('_t', Date.now());
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'no-cors' // Important for Google Apps Script
                }).catch(error => {
                    // If fetch fails, use offline mode
                    throw new Error('Network error');
                });
                
                // Note: With 'no-cors' mode, we can't read response
                // So we'll use a different approach
                return await callAPIWithProxy(action, params);
                
            } catch (error) {
                console.log(`API ${action} failed, using offline mode:`, error);
                state.offlineMode = true;
                return await handleOfflineAction(action, params);
            }
        }

        // Proxy method to handle CORS
        async function callAPIWithProxy(action, params) {
            try {
                // Create form data
                const formData = new FormData();
                formData.append('action', action);
                Object.keys(params).forEach(key => {
                    formData.append(key, params[key]);
                });
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                state.offlineMode = false;
                updateDbStatus(true);
                return data;
                
            } catch (error) {
                console.log(`API ${action} failed, using offline mode:`, error);
                state.offlineMode = true;
                updateDbStatus(false);
                return await handleOfflineAction(action, params);
            }
        }

        // Handle actions in offline mode
        async function handleOfflineAction(action, params) {
            // Load from localStorage first
            loadFromLocalStorage();
            
            switch(action) {
                case 'getUsers':
                    return { success: true, users: state.users };
                case 'getWithdrawals':
                    return { success: true, withdrawals: state.withdrawals };
                case 'getSettings':
                    return { success: true, settings: state.settings };
                case 'login':
                    return handleOfflineLogin(params);
                case 'register':
                    return handleOfflineRegister(params);
                case 'updateUser':
                    return handleOfflineUpdateUser(params);
                case 'createWithdrawal':
                    return handleOfflineCreateWithdrawal(params);
                case 'updateWithdrawal':
                    return handleOfflineUpdateWithdrawal(params);
                case 'updateSettings':
                    return handleOfflineUpdateSettings(params);
                default:
                    return { success: false, error: 'Action not supported offline' };
            }
        }

        // Offline handlers
        function handleOfflineLogin(params) {
            const user = state.users.find(u => 
                u.username === params.username && 
                u.password === params.password && 
                u.isBlocked !== 'true'
            );
            
            if (user) {
                // Update last login
                user.lastLogin = new Date().toISOString();
                saveToLocalStorage();
                
                return { 
                    success: true, 
                    message: 'Login berhasil (offline mode)', 
                    user: user 
                };
            }
            
            return { success: false, error: 'Username atau password salah' };
        }

        function handleOfflineRegister(params) {
            if (state.users.some(u => u.username === params.username)) {
                return { success: false, error: 'Username sudah digunakan' };
            }
            
            const role = state.users.length === 0 ? 'admin' : 'user';
            const id = state.users.length + 1;
            
            const newUser = {
                id: id,
                username: params.username,
                password: params.password,
                role: role,
                points: 0,
                joinDate: new Date().toISOString(),
                deviceId: state.deviceId,
                isBlocked: 'false',
                lastLogin: ''
            };
            
            state.users.push(newUser);
            saveToLocalStorage();
            
            return { 
                success: true, 
                message: 'Pendaftaran berhasil (offline mode)', 
                user: newUser 
            };
        }

        // Local storage functions
        function saveToLocalStorage() {
            localStorage.setItem('quizApp_users', JSON.stringify(state.users));
            localStorage.setItem('quizApp_withdrawals', JSON.stringify(state.withdrawals));
            localStorage.setItem('quizApp_settings', JSON.stringify(state.settings));
            localStorage.setItem('quizApp_lastSync', Date.now().toString());
        }

        function loadFromLocalStorage() {
            const users = localStorage.getItem('quizApp_users');
            const withdrawals = localStorage.getItem('quizApp_withdrawals');
            const settings = localStorage.getItem('quizApp_settings');
            
            if (users) state.users = JSON.parse(users);
            if (withdrawals) state.withdrawals = JSON.parse(withdrawals);
            if (settings) state.settings = JSON.parse(settings);
            
            // Set maintenance and reward points
            state.maintenance = state.settings.maintenance === 'true';
            state.rewardPoints = parseInt(state.settings.rewardPoints) || 50;
        }

        // Initialize application
        async function initializeApp() {
            try {
                showLoading('Memuat aplikasi...');
                
                // Try to load from API first
                const [usersData, withdrawalsData, settingsData] = await Promise.all([
                    callAPI('getUsers'),
                    callAPI('getWithdrawals'),
                    callAPI('getSettings')
                ]);
                
                if (usersData.success) state.users = usersData.users;
                if (withdrawalsData.success) state.withdrawals = withdrawalsData.withdrawals;
                if (settingsData.success) {
                    state.settings = settingsData.settings;
                    state.maintenance = settingsData.settings.maintenance === 'true';
                    state.rewardPoints = parseInt(settingsData.settings.rewardPoints) || 50;
                }
                
                // Save to localStorage for offline use
                saveToLocalStorage();
                
                hideLoading();
                
                // Check if user is already logged in
                const savedUserId = localStorage.getItem('currentUserId');
                if (savedUserId) {
                    const user = state.users.find(u => u.id == savedUserId);
                    if (user) {
                        if (await login(user.username, user.password)) {
                            return;
                        }
                    }
                }
                
                showLogin();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback to localStorage
                loadFromLocalStorage();
                hideLoading();
                showLogin();
            }
        }

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function showLoading(message = 'Memuat...') {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateDbStatus(isOnline) {
            const dbStatus = document.getElementById('dbStatus');
            const dbStatusText = document.getElementById('dbStatusText');
            
            if (isOnline) {
                dbStatusText.textContent = 'Database: Online';
                dbStatusText.className = 'db-online';
                dbStatus.style.display = 'block';
            } else {
                dbStatusText.textContent = 'Database: Offline';
                dbStatusText.className = 'db-offline';
                dbStatus.style.display = 'block';
            }
            
            if (isOnline) {
                setTimeout(() => {
                    dbStatus.style.display = 'none';
                }, 3000);
            }
        }

        // Authentication Functions
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('noAccountMessage').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'flex';
        }

        async function login(username, password) {
            try {
                const result = await callAPI('login', {
                    username: username,
                    password: password
                });
                
                if (result.success) {
                    state.currentUser = result.user;
                    localStorage.setItem('currentUserId', result.user.id);
                    
                    showToast(result.message, 'success');
                    
                    if (state.maintenance) {
                        showMaintenancePage();
                    } else {
                        showApp();
                    }
                    
                    updateUserInfo();
                    updateRewardButton();
                    generateNewQuestion();
                    
                    if (state.currentUser.role === 'admin') {
                        addSettingsMenu();
                    } else {
                        removeSettingsMenu();
                    }
                    
                    return true;
                } else {
                    showToast(result.error, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Gagal login', 'error');
                return false;
            }
        }

        async function logout() {
            removeSettingsMenu();
            state.currentUser = null;
            localStorage.removeItem('currentUserId');
            showLogin();
            showToast('Anda telah logout', 'success');
        }

        async function register(username, password) {
            try {
                const result = await callAPI('register', {
                    username: username,
                    password: password,
                    deviceId: state.deviceId
                });
                
                if (result.success) {
                    // Update local state
                    state.users.push(result.user);
                    saveToLocalStorage();
                    
                    showToast(result.message, 'success');
                    showLogin();
                    return true;
                } else {
                    showToast(result.error, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Register error:', error);
                showToast('Gagal mendaftar', 'error');
                return false;
            }
        }

        // Quiz Functions
        function generateNewQuestion() {
            const num1 = Math.floor(Math.random() * 100) + 1;
            const num2 = Math.floor(Math.random() * 100) + 1;
            const answer = num1 + num2;
            
            state.currentQuestion = `${num1} + ${num2}`;
            state.correctAnswer = answer;
            
            const wrongAnswers = [];
            while (wrongAnswers.length < 3) {
                const wrongAnswer = answer + Math.floor(Math.random() * 20) - 10;
                if (wrongAnswer !== answer && wrongAnswer > 0 && !wrongAnswers.includes(wrongAnswer)) {
                    wrongAnswers.push(wrongAnswer);
                }
            }
            
            const allAnswers = [answer, ...wrongAnswers];
            shuffleArray(allAnswers);
            
            document.getElementById('question').textContent = state.currentQuestion;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            allAnswers.forEach((ans, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = ans;
                button.onclick = () => checkAnswer(ans);
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('rewardBtn').style.display = 'none';
        }

        function checkAnswer(selectedAnswer) {
            if (parseInt(selectedAnswer) === state.correctAnswer) {
                showToast('Jawaban benar! ðŸŽ‰', 'success');
                document.getElementById('rewardBtn').style.display = 'block';
            } else {
                showToast('Jawaban salah ðŸ˜¢', 'error');
                setTimeout(generateNewQuestion, 1000);
            }
            
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });
        }

        async function claimReward() {
            try {
                if (typeof show_9865183 !== 'undefined') {
                    show_9865183().then(async () => {
                        await rewardUserPoints();
                    }).catch(async error => {
                        console.error('Ad error:', error);
                        showToast('Gagal menampilkan iklan', 'error');
                        await simulateAdSuccess();
                    });
                } else {
                    await simulateAdSuccess();
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function rewardUserPoints() {
            if (state.currentUser) {
                const newPoints = parseInt(state.currentUser.points) + state.rewardPoints;
                
                // Update in API
                const result = await callAPI('updateUser', {
                    userId: state.currentUser.id,
                    points: newPoints
                });
                
                if (result.success) {
                    // Update local state
                    state.currentUser.points = newPoints;
                    const userIndex = state.users.findIndex(u => u.id == state.currentUser.id);
                    if (userIndex !== -1) {
                        state.users[userIndex].points = newPoints;
                        saveToLocalStorage();
                    }
                    
                    updateUserInfo();
                    showToast(`Reward ${state.rewardPoints} poin berhasil diklaim!`, 'success');
                    document.getElementById('rewardBtn').style.display = 'none';
                    generateNewQuestion();
                } else {
                    showToast('Gagal mengupdate poin', 'error');
                }
            }
        }

        // Update user info in UI
        function updateUserInfo() {
            if (state.currentUser) {
                document.getElementById('userGreeting').textContent = `Halo, ${state.currentUser.username}!`;
                document.getElementById('userPoints').textContent = state.currentUser.points;
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                await login(username, password);
            });
            
            // Register form
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('registerUsername').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                
                if (password !== confirmPassword) {
                    showToast('Password tidak cocok', 'error');
                    return;
                }
                
                await register(username, password);
            });
            
            // Withdrawal form
            document.getElementById('withdrawalForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const points = document.getElementById('withdrawalPoints').value;
                const accountName = document.getElementById('danaAccountName').value;
                const phone = document.getElementById('danaPhone').value;
                
                await submitWithdrawal(points, accountName, phone);
            });
            
            // Reward button
            document.getElementById('rewardBtn').addEventListener('click', claimReward);
        });

        // Helper functions
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function addSettingsMenu() {
            const navMenu = document.getElementById('navMenu');
            if (!document.getElementById('navSettingsItem')) {
                const settingsItem = document.createElement('li');
                settingsItem.className = 'nav-item';
                settingsItem.id = 'navSettingsItem';
                settingsItem.innerHTML = `
                    <a href="#" class="nav-link" onclick="showPage('settings')" id="navSettings">
                        <i class="fas fa-cog"></i>
                        <span>Setting</span>
                    </a>
                `;
                navMenu.appendChild(settingsItem);
            }
        }

        function removeSettingsMenu() {
            const settingsItem = document.getElementById('navSettingsItem');
            if (settingsItem) {
                settingsItem.remove();
            }
        }

        // Page navigation functions
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.getElementById(`${pageName}Page`).style.display = 'block';
            
            const navElement = document.getElementById(`nav${pageName.charAt(0).toUpperCase() + pageName.slice(1)}`);
            if (navElement) {
                navElement.classList.add('active');
            }
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            showPage('quiz');
        }

        function showMaintenancePage() {
            document.getElementById('appContainer').style.display = 'block';
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById('maintenancePage').style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
        }

        // Simpan function lainnya yang sudah ada sebelumnya
        // ... (paste semua fungsi JavaScript lainnya dari kode sebelumnya) ...

    </script>
</body>
</html>
