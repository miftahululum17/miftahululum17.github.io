<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Administrasi Piket Terkoneksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-counter { padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bg-sakit { background: linear-gradient(45deg, #ffc107, #ffca2c); color: #000; }
        .bg-ijin { background: linear-gradient(45deg, #17a2b8, #138496); }
        .bg-bolos { background: linear-gradient(45deg, #dc3545, #c82333); }
        .bg-total { background: linear-gradient(45deg, #28a745, #218838); }
        #preview-foto { max-width: 100%; height: auto; display: none; margin-top: 10px; border-radius: 8px; border: 2px dashed #ddd; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3">Sedang Mengirim ke Google Sheet...</h5>
</div>

<nav class="navbar navbar-dark bg-primary mb-4 shadow">
    <div class="container">
        <span class="navbar-brand mb-0 h1 fw-bold">üè´ E-Piket Cloud</span>
    </div>
</nav>

<div class="container">
    <h4 class="mb-3 fw-bold text-secondary">üìä Dashboard Hari Ini</h4>
    <div class="row text-center">
        <div class="col-6 col-md-3"><div class="card-counter bg-total"><h3><span id="count-total">0</span></h3><small>Total Input</small></div></div>
        <div class="col-6 col-md-3"><div class="card-counter bg-sakit"><h3><span id="count-sakit">0</span></h3><small>Sakit</small></div></div>
        <div class="col-6 col-md-3"><div class="card-counter bg-ijin"><h3><span id="count-ijin">0</span></h3><small>Ijin</small></div></div>
        <div class="col-6 col-md-3"><div class="card-counter bg-bolos"><h3><span id="count-lain">0</span></h3><small>Lainnya</small></div></div>
    </div>

    <hr>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow border-0">
                <div class="card-header bg-white border-bottom-0 pt-4">
                    <h5 class="mb-0 fw-bold text-primary">üìù Form Input Ijin</h5>
                </div>
                <div class="card-body">
                    <form id="formPiket">
                        <div class="mb-3">
                            <label class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="tanggal" name="tanggal" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Petugas Piket</label>
                            <input type="text" class="form-control" id="petugas" name="petugas" placeholder="Nama Guru" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">NIS</label>
                                <input type="number" class="form-control" id="nis" name="nis" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Kelas</label>
                                <select class="form-select" id="kelas" name="kelas" required>
                                    <option value="">Pilih</option>
                                    <option value="X">Kelas X</option>
                                    <option value="XI">Kelas XI</option>
                                    <option value="XII">Kelas XII</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Siswa</label>
                            <input type="text" class="form-control" id="nama" name="nama" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jenis Ijin</label>
                            <select class="form-select" id="jenisIjin" name="jenis" required>
                                <option value="Sakit">Sakit</option>
                                <option value="Ijin">Ijin</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keterangan</label>
                            <textarea class="form-control" id="keterangan" name="keterangan" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Foto Bukti</label>
                            <input type="file" class="form-control" id="fotoInput" accept="image/*" capture="environment">
                            <img id="preview-foto" src="#">
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">üöÄ KIRIM DATA</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow border-0">
                <div class="card-header bg-white pt-4">
                    <h5 class="mb-0 fw-bold">üìÇ Riwayat Sesi Ini</h5>
                    <small class="text-muted">Data di bawah ini hanya tampilan sementara.</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabelData">
                            <thead class="table-light">
                                <tr><th>Nama</th><th>Kls</th><th>Status</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // PASTE URL WEB APP ANDA DI BAWAH INI !!!
    // ==========================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwm1K0QapOc3ng4G28rFcf8m97UN4i_lNBPR6peVKlEkmsiFTQx5sNoBzKYRY3z9Rq4/exec'; 
    // Contoh: https://script.google.com/macros/s/AKfycbx.../exec
    // ==========================================

    document.getElementById('tanggal').valueAsDate = new Date();
    const form = document.getElementById('formPiket');
    const loading = document.getElementById('loading');
    const previewFoto = document.getElementById('preview-foto');
    let base64Foto = "";

    // 1. Handle Preview & Convert Foto ke Base64
    document.getElementById('fotoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = function() {
                base64Foto = reader.result; // Simpan string base64
                previewFoto.src = base64Foto;
                previewFoto.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    });

    // 2. Handle Kirim Data
    form.addEventListener('submit', e => {
        e.preventDefault();
        
        if(SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbwm1K0QapOc3ng4G28rFcf8m97UN4i_lNBPR6peVKlEkmsiFTQx5sNoBzKYRY3z9Rq4/exec' || SCRIPT_URL === '') {
            Swal.fire('Error', 'Mohon masukkan URL Google Script di kode HTML!', 'error');
            return;
        }

        loading.style.display = 'flex'; // Tampilkan loading

        // Siapkan data object
        let formData = {
            tanggal: document.getElementById('tanggal').value,
            petugas: document.getElementById('petugas').value,
            nis: document.getElementById('nis').value,
            kelas: document.getElementById('kelas').value,
            nama: document.getElementById('nama').value,
            jenis: document.getElementById('jenisIjin').value,
            keterangan: document.getElementById('keterangan').value,
            foto: base64Foto, // String gambar
            namaFile: document.getElementById('nama').value + '_' + Date.now() + '.jpg'
        };

        // Kirim ke Google Script
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Penting untuk Google Script
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(() => {
            // Berhasil
            loading.style.display = 'none';
            Swal.fire({
                title: 'Berhasil!',
                text: 'Data tersimpan di Google Sheet & Foto di Drive',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            // Update Dashboard Lokal
            updateDashboardLokal(formData);
            
            // Reset Form
            form.reset();
            document.getElementById('tanggal').valueAsDate = new Date();
            previewFoto.style.display = 'none';
            base64Foto = "";
        })
        .catch(error => {
            loading.style.display = 'none';
            Swal.fire('Oups!', 'Gagal koneksi ke server.', 'error');
            console.error('Error:', error);
        });
    });

    // 3. Update Dashboard Lokal (Visual Saja)
    let dataLokal = [];
    function updateDashboardLokal(data) {
        dataLokal.push(data);
        
        // Update Table
        const tbody = document.querySelector('#tabelData tbody');
        const row = `<tr><td>${data.nama}</td><td>${data.kelas}</td><td><span class="badge bg-secondary">${data.jenis}</span></td></tr>`;
        tbody.innerHTML += row;

        // Update Counter
        document.getElementById('count-total').innerText = dataLokal.length;
        document.getElementById('count-sakit').innerText = dataLokal.filter(x => x.jenis === 'Sakit').length;
        document.getElementById('count-ijin').innerText = dataLokal.filter(x => x.jenis === 'Ijin').length;
        document.getElementById('count-lain').innerText = dataLokal.filter(x => x.jenis === 'Lainnya').length;
    }
</script>

</body>
</html>
